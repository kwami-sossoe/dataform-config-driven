<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REX: Modern Data Stack GCP - Terraform & Dataform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for code blocks */
        .code-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .code-scroll::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        .code-scroll::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .code-scroll::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .node-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.02);
        }
    </style>
    <!-- Chosen Palette: Google Cloud Inspired (Blue #1a73e8, Red #ea4335, Green #34a853, Yellow #fbbc04) with Slate basics -->
    <!-- Application Structure Plan: 
         1. Hero Section: High-level overview of the "Event-Driven Serverless" goal.
         2. Interactive Architecture: A clickable block diagram representing the flow (GCS -> Workflows -> BQ).
         3. Terraform Deep Dive: Focus on the specific Gen1 vs Gen2 technical challenge mentioned in the report.
         4. Dataform Playground: An interactive section demonstrating the "Config-Driven" approach (JSON input -> SQL output).
         5. DataOps & FinOps Dashboard: Visualizing the impacts (Quality, CI/CD, Cost) using Chart.js.
    -->
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚òÅÔ∏è</span>
                    <span class="font-bold text-xl text-slate-800 tracking-tight">Modern Data Stack <span class="text-blue-600">GCP</span></span>
                </div>
                <div class="hidden md:flex space-x-8 items-center">
                    <button onclick="scrollToSection('architecture')" class="text-slate-600 hover:text-blue-600 px-3 py-2 text-sm font-medium transition-colors">Architecture</button>
                    <button onclick="scrollToSection('terraform')" class="text-slate-600 hover:text-blue-600 px-3 py-2 text-sm font-medium transition-colors">Terraform (IaC)</button>
                    <button onclick="scrollToSection('dataform')" class="text-slate-600 hover:text-blue-600 px-3 py-2 text-sm font-medium transition-colors">Dataform Config</button>
                    <button onclick="scrollToSection('impact')" class="text-slate-600 hover:text-blue-600 px-3 py-2 text-sm font-medium transition-colors">DataOps & FinOps</button>
                </div>
                <!-- Mobile menu button (simple implementation) -->
                <div class="md:hidden flex items-center">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-slate-600 hover:text-blue-600 p-2">
                        ‚ò∞
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="scrollToSection('architecture')" class="block w-full text-left text-slate-600 hover:text-blue-600 px-3 py-2 text-base font-medium">Architecture</button>
                <button onclick="scrollToSection('terraform')" class="block w-full text-left text-slate-600 hover:text-blue-600 px-3 py-2 text-base font-medium">Terraform</button>
                <button onclick="scrollToSection('dataform')" class="block w-full text-left text-slate-600 hover:text-blue-600 px-3 py-2 text-base font-medium">Dataform</button>
                <button onclick="scrollToSection('impact')" class="block w-full text-left text-slate-600 hover:text-blue-600 px-3 py-2 text-base font-medium">Impact</button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-white">
        <div class="max-w-7xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl tracking-tight font-extrabold text-slate-900 sm:text-5xl md:text-6xl">
                <span class="block">REX : Infrastructure & Data</span>
                <span class="block text-blue-600">Event-Driven & Config-Driven</span>
            </h1>
            <p class="mt-3 max-w-md mx-auto text-base text-slate-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
                Retour d'exp√©rience sur la construction d'une pipeline d'ingestion robuste, immuable et serverless sur Google Cloud Platform pour Open Food Facts.
            </p>
            <div class="mt-5 max-w-md mx-auto flex justify-center md:mt-8 gap-4">
                <div class="flex items-center text-sm font-semibold text-slate-600">
                    <span class="bg-green-100 text-green-800 py-1 px-2 rounded-full mr-2">100%</span> Serverless
                </div>
                <div class="flex items-center text-sm font-semibold text-slate-600">
                    <span class="bg-blue-100 text-blue-800 py-1 px-2 rounded-full mr-2">IaC</span> Terraform
                </div>
                <div class="flex items-center text-sm font-semibold text-slate-600">
                    <span class="bg-orange-100 text-orange-800 py-1 px-2 rounded-full mr-2">ELT</span> Dataform
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">

        <!-- SECTION 1: ARCHITECTURE EXPLORER -->
        <!-- Visualization & Content Choices: Interactive block diagram. Clicking blocks updates a detail pane. Replaces Mermaid with interactive HTML/CSS. -->
        <section id="architecture" class="py-12 border-t border-slate-200">
            <div class="mb-10 text-center">
                <h2 class="text-3xl font-extrabold text-slate-900">Architecture Vue d'H√©licopt√®re</h2>
                <p class="mt-4 text-lg text-slate-600">Explorez le flux de donn√©es en cliquant sur les composants.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Interactive Diagram Area -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1 rounded-br-lg">FLUX √âV√âNEMENTIEL</div>
                    
                    <div class="flex flex-col gap-8 mt-6">
                        <!-- Step 1: Ingestion -->
                        <div class="flex flex-col md:flex-row items-center gap-4 justify-center">
                            <div onclick="updateArchDetails('gcs')" class="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-blue-400 p-4 rounded-lg w-full md:w-48 text-center transition-all duration-200 arch-node group" id="node-gcs">
                                <div class="text-3xl mb-2">üìÇ</div>
                                <div class="font-bold text-slate-700 group-hover:text-blue-600">GCS Landing Zone</div>
                                <div class="text-xs text-slate-500">JSON File Upload</div>
                            </div>
                            <div class="text-slate-300 text-2xl hidden md:block">‚ûî</div>
                            <div class="text-slate-300 text-2xl md:hidden">‚¨á</div>
                            <div onclick="updateArchDetails('pubsub')" class="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-blue-400 p-4 rounded-lg w-full md:w-48 text-center transition-all duration-200 arch-node group" id="node-pubsub">
                                <div class="text-3xl mb-2">üîî</div>
                                <div class="font-bold text-slate-700 group-hover:text-blue-600">Pub/Sub & Eventarc</div>
                                <div class="text-xs text-slate-500">Trigger</div>
                            </div>
                        </div>

                        <!-- Step 2: Orchestration -->
                        <div class="flex flex-col items-center justify-center">
                            <div class="h-8 w-0.5 bg-slate-300"></div>
                            <div class="text-slate-300 text-xl">‚¨á</div>
                            <div onclick="updateArchDetails('workflows')" class="cursor-pointer bg-green-50 border-2 border-green-200 hover:border-green-400 p-4 rounded-lg w-full md:w-64 text-center transition-all duration-200 arch-node group shadow-sm" id="node-workflows">
                                <div class="text-3xl mb-2">‚öôÔ∏è</div>
                                <div class="font-bold text-slate-800 group-hover:text-green-700">Cloud Workflows</div>
                                <div class="text-xs text-slate-500">Orchestrateur & Chef d'orchestre</div>
                            </div>
                            <div class="h-8 w-0.5 bg-slate-300"></div>
                            <div class="text-slate-300 text-xl">‚¨á</div>
                        </div>

                        <!-- Step 3: Compute & Transform -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div onclick="updateArchDetails('bq')" class="cursor-pointer bg-slate-50 border-2 border-slate-200 hover:border-yellow-400 p-4 rounded-lg text-center transition-all duration-200 arch-node group" id="node-bq">
                                <div class="text-3xl mb-2">üîé</div>
                                <div class="font-bold text-slate-700 group-hover:text-yellow-600">BigQuery (Raw)</div>
                                <div class="text-xs text-slate-500">1. Load Temp</div>
                            </div>
                            <div onclick="updateArchDetails('dataform')" class="cursor-pointer bg-red-50 border-2 border-red-200 hover:border-red-400 p-4 rounded-lg text-center transition-all duration-200 arch-node group" id="node-dataform">
                                <div class="text-3xl mb-2">üõ†Ô∏è</div>
                                <div class="font-bold text-slate-800 group-hover:text-red-600">Dataform Core</div>
                                <div class="text-xs text-slate-500">2. Trigger & Compile SQL</div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Final -->
                        <div class="flex justify-center mt-2">
                             <div class="w-full md:w-2/3 border-t-2 border-dashed border-slate-300 pt-4 text-center">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">R√©sultat</div>
                                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg inline-block">
                                    <span class="text-2xl align-middle mr-2">üìä</span>
                                    <span class="font-bold text-slate-700 align-middle">BigQuery Marts</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Detail Pane -->
                <div class="lg:col-span-1 bg-slate-800 text-white rounded-xl shadow-lg p-6 flex flex-col justify-center transition-all duration-300" id="arch-details">
                    <div class="mb-4 text-blue-400 text-4xl">üëÜ</div>
                    <h3 class="text-xl font-bold mb-2">Explorateur d'Architecture</h3>
                    <p class="text-slate-300">Cliquez sur un composant du diagramme pour voir son r√¥le technique, ses configurations Terraform sp√©cifiques et son interaction dans le pipeline.</p>
                </div>
            </div>
        </section>

        <!-- SECTION 2: TERRAFORM DEEP DIVE (GEN1 VS GEN2) -->
        <!-- Visualization: Comparison Toggle Card. -->
        <section id="terraform" class="py-16">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-extrabold text-slate-900">Le D√©fi Infrastructure as Code</h2>
                    <p class="mt-4 text-lg text-slate-600">
                        La connexion entre GitHub et Cloud Build a √©volu√©. Pour une infrastructure r√©gionale (<code class="bg-slate-100 px-1 rounded text-red-500">europe-west1</code>), l'approche historique ne fonctionne plus.
                    </p>
                </div>

                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="flex border-b border-slate-200">
                        <button onclick="switchTerraformTab('legacy')" id="tab-legacy" class="flex-1 py-4 text-center font-bold text-slate-500 hover:bg-slate-50 border-b-2 border-transparent transition-all">Legacy (Gen 1) ‚ùå</button>
                        <button onclick="switchTerraformTab('modern')" id="tab-modern" class="flex-1 py-4 text-center font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-all">Modern (Gen 2) ‚úÖ</button>
                    </div>
                    
                    <div class="p-6 md:p-8 bg-slate-900 text-slate-300 font-mono text-sm code-scroll overflow-x-auto h-96" id="tf-code-display">
                        <!-- Content injected via JS -->
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-200 text-sm text-slate-600" id="tf-explanation">
                        <!-- Explanation injected via JS -->
                    </div>
                </div>
                
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                        <h4 class="font-bold text-red-700">Le Pi√®ge Gen 1</h4>
                        <p class="text-sm text-red-600 mt-1">Le bloc `github {}` force une localisation <strong>Global</strong>. Impossible √† utiliser avec des contraintes de r√©sidence des donn√©es strictes (RGPD).</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-bold text-green-700">La Solution Gen 2</h4>
                        <p class="text-sm text-green-600 mt-1">Utilise `google_cloudbuildv2_repository` pour faire le pont via Secret Manager. Supporte <strong>europe-west1</strong> nativement.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: DATAFORM CONFIG DRIVEN -->
        <!-- Visualization: Split screen editor simulation. -->
        <section id="dataform" class="py-16 bg-slate-100 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-extrabold text-slate-900">L'Approche "Config Driven"</h2>
                    <p class="mt-4 text-lg text-slate-600">
                        Pourquoi √©crire du SQL r√©p√©titif ? Utilisez JavaScript pour g√©n√©rer vos pipelines dynamiquement √† partir de configurations JSON.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
                    <!-- Config Input -->
                    <div class="bg-white rounded-lg shadow p-4 flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-slate-700 text-sm">üìÑ definitions/schemas/staging/stg_off_products.json</span>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">Configuration</span>
                        </div>
                        <textarea id="json-input" class="w-full h-64 bg-slate-50 border border-slate-300 rounded p-3 font-mono text-xs text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none resize-none" spellcheck="false">
{
  "tableName": "stg_off_products",
  "description": "Nettoyage technique des produits OFF.",
  "sourceTable": "off_raw_dump",
  "columns": {
    "code": "Code barre (PK)",
    "product_name": "Nom produit"
  },
  "qualityChecks": {
    "nutriscore": true,
    "uniqueKey": "code"
  }
}</textarea>
                        <div class="mt-2 text-right">
                            <button onclick="generateSQL()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded transition-colors shadow-sm">
                                G√©n√©rer le SQL ‚ö°
                            </button>
                        </div>
                    </div>

                    <!-- SQL Output -->
                    <div class="bg-slate-800 rounded-lg shadow p-4 flex flex-col relative">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-slate-300 text-sm">üõ†Ô∏è Generated SQL (Compiled)</span>
                            <span class="text-xs bg-slate-700 text-slate-400 px-2 py-1 rounded">Read-only</span>
                        </div>
                        <pre id="sql-output" class="w-full h-full bg-slate-900 rounded p-3 font-mono text-xs text-green-400 overflow-auto whitespace-pre-wrap code-scroll">
-- Cliquez sur "G√©n√©rer" pour voir le r√©sultat de la factory JS...
                        </pre>
                        
                        <!-- JS Overlay Info -->
                        <div class="absolute bottom-4 right-4 max-w-xs bg-slate-700/90 backdrop-blur text-white text-xs p-3 rounded border border-slate-600 shadow-lg">
                            <strong>Le Pattern Factory JS :</strong><br>
                            Le code JavaScript (`publish(...)`) lit le JSON de gauche et injecte automatiquement les r√®gles de qualit√© (`assertions`) et la documentation.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: DATAOPS & FINOPS DASHBOARD -->
        <!-- Visualization: Charts using Chart.js. -->
        <section id="impact" class="py-16">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold text-slate-900">DataOps & Optimisation FinOps</h2>
                    <p class="mt-4 text-lg text-slate-600">
                        L'impact concret de l'automatisation et du partitionnement sur la fiabilit√© et les co√ªts.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    
                    <!-- Card 1: Cost Optimization -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <span class="bg-green-100 text-green-600 p-2 rounded-lg mr-3">üí∞</span>
                            Co√ªt BigQuery Query
                        </h3>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-500 mt-4 text-center">Impact du partitionnement sur <code>ingestion_date</code></p>
                    </div>

                    <!-- Card 2: Pipeline Reliability -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <span class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">üõ°Ô∏è</span>
                            Stabilit√© Pipeline (CI/CD)
                        </h3>
                        <div class="chart-container">
                            <canvas id="reliabilityChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-500 mt-4 text-center">R√©duction des √©checs gr√¢ce √† <code>dataform test</code></p>
                    </div>

                    <!-- Card 3: Key Metrics -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100 flex flex-col justify-between">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <span class="bg-yellow-100 text-yellow-600 p-2 rounded-lg mr-3">‚ö°</span>
                            KPIs Projet
                        </h3>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Maintenance Infra</span>
                                    <span class="font-bold text-green-600">-80%</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 20%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Temps de D√©ploiement</span>
                                    <span class="font-bold text-blue-600">~2 min</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 15%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Qualit√© Donn√©e (Rejet)</span>
                                    <span class="font-bold text-orange-600">Automatis√©</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 bg-slate-50 p-4 rounded text-sm text-slate-600">
                            <strong>Conclusion :</strong> Le passage √† une stack 100% code (Terraform + Dataform JS) a transform√© une t√¢che manuelle risqu√©e en un processus industriel fiable.
                        </div>
                    </div>

                </div>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p>REX Masterclass: Modern Data Stack GCP &copy; 2025</p>
            <p class="mt-2">G√©n√©r√© √† partir du rapport technique Terraform & Dataform.</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // 1. Navigation Logic
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
                // Close mobile menu if open
                document.getElementById('mobile-menu').classList.add('hidden');
            }
        }

        // 2. Interactive Architecture Diagram Logic
        const archData = {
            'gcs': {
                title: 'üìÇ GCS Landing Zone',
                content: 'Point d\'entr√©e du pipeline. Les fichiers JSON bruts sont d√©pos√©s ici. Terraform configure une <strong>Notification</strong> sur le bucket qui envoie un message Pub/Sub √† chaque √©v√©nement <code>OBJECT_FINALIZE</code>.',
                color: 'text-blue-400'
            },
            'pubsub': {
                title: 'üîî Pub/Sub & Eventarc',
                content: 'Le syst√®me nerveux. Eventarc √©coute le topic Pub/Sub et filtre les √©v√©nements. Il agit comme un trigger pour le Workflow, assurant une architecture 100% √©v√©nementielle (Push vs Pull).',
                color: 'text-slate-300'
            },
            'workflows': {
                title: '‚öôÔ∏è Cloud Workflows',
                content: 'Le chef d\'orchestre Serverless. Il ex√©cute une s√©quence d√©finie en YAML : <br>1. Charge le fichier GCS dans une table temporaire BQ.<br>2. Appelle l\'API Dataform pour lancer la compilation et l\'ex√©cution du SQL.',
                color: 'text-green-400'
            },
            'bq': {
                title: 'üîé BigQuery (Raw)',
                content: 'Stockage brut. Utilise le pattern <strong>Schema-on-read</strong>. Tout le contenu JSON est charg√© dans une seule colonne <code>raw_json</code> de type JSON pour √©viter les erreurs de parsing √† l\'ingestion.',
                color: 'text-yellow-400'
            },
            'dataform': {
                title: 'üõ†Ô∏è Dataform Core',
                content: 'Le moteur de transformation. Il compile le code JS/SQLX en un graphe de d√©pendances (DAG). Il ex√©cute ensuite les requ√™tes <code>MERGE</code> ou <code>CREATE OR REPLACE</code> dans BigQuery pour cr√©er les tables propres.',
                color: 'text-red-400'
            }
        };

        function updateArchDetails(nodeId) {
            // UI Update
            document.querySelectorAll('.arch-node').forEach(el => {
                el.classList.remove('node-active', 'ring-2', 'ring-offset-2', 'ring-blue-400');
            });
            document.getElementById('node-' + nodeId).classList.add('node-active', 'ring-2', 'ring-offset-2', 'ring-blue-400');

            // Content Update
            const data = archData[nodeId];
            const detailsPane = document.getElementById('arch-details');
            
            // Simple fade out/in effect
            detailsPane.style.opacity = '0';
            setTimeout(() => {
                detailsPane.innerHTML = `
                    <div class="mb-4 ${data.color} text-4xl">‚ö°</div>
                    <h3 class="text-xl font-bold mb-2 text-white">${data.title}</h3>
                    <div class="text-slate-300 text-sm leading-relaxed">${data.content}</div>
                `;
                detailsPane.style.opacity = '1';
            }, 300);
        }

        // 3. Terraform Tab Logic
        const terraformCode = {
            'legacy': {
                code: `# ‚ùå ANCIENNE APPROCHE (Gen 1)
# Ne fonctionne qu'avec location = "global"
# Probl√©matique pour la compliance RGPD (europe-west1)

resource "google_cloudbuild_trigger" "legacy_trigger" {
  name     = "trigger-legacy"
  location = "global" # <--- Contrainte bloquante

  github {
    owner = var.github_repo_owner
    name  = var.dataform_repo_name
    push {
      branch = "^main$"
    }
  }
}`,
                explanation: "Cette configuration utilise l'ancien bloc `github`. Elle √©choue souvent avec une erreur 400 si vous tentez de forcer une r√©gion sp√©cifique, et n√©cessite une connexion manuelle OAuth."
            },
            'modern': {
                code: `# ‚úÖ NOUVELLE APPROCHE (Gen 2)
# Supporte nativement les r√©gions (europe-west1)
# Utilise Secret Manager pour une s√©curit√© accrue

resource "google_cloudbuildv2_repository" "my_repo" {
  location          = "europe-west1" # <--- Succ√®s !
  name              = "my-repo"
  parent_connection = google_cloudbuildv2_connection.gh_conn.name
  remote_uri        = "https://github.com/org/repo.git"
}

resource "google_cloudbuild_trigger" "gen2_trigger" {
  location = "europe-west1"
  repository_event_config {
    repository = google_cloudbuildv2_repository.my_repo.id
    push { branch = "^main$" }
  }
}`,
                explanation: "L'approche moderne s√©pare la connexion (authentification) du d√©p√¥t (lien logique). Cela permet de d√©ployer des triggers strictement r√©gionaux et respectueux de la souverainet√© des donn√©es."
            }
        };

        function switchTerraformTab(tab) {
            // Style updates
            document.getElementById('tab-legacy').className = tab === 'legacy' 
                ? "flex-1 py-4 text-center font-bold text-red-600 border-b-2 border-red-600 bg-red-50 transition-all"
                : "flex-1 py-4 text-center font-bold text-slate-500 hover:bg-slate-50 border-b-2 border-transparent transition-all";
            
            document.getElementById('tab-modern').className = tab === 'modern'
                ? "flex-1 py-4 text-center font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-all"
                : "flex-1 py-4 text-center font-bold text-slate-500 hover:bg-slate-50 border-b-2 border-transparent transition-all";

            // Content Update
            document.getElementById('tf-code-display').innerText = terraformCode[tab].code;
            document.getElementById('tf-explanation').innerText = terraformCode[tab].explanation;
        }

        // Initialize Terraform tab
        switchTerraformTab('modern');

        // 4. Dataform Playground Logic
        function generateSQL() {
            const inputVal = document.getElementById('json-input').value;
            let config;
            try {
                config = JSON.parse(inputVal);
            } catch (e) {
                document.getElementById('sql-output').innerText = "-- Erreur JSON : " + e.message;
                return;
            }

            const qualityCheckSQL = config.qualityChecks.nutriscore 
                ? `\n  -- R√®gle Qualit√© inject√©e par JS\n  AND LOWER(nutriscore_grade) IN ('a', 'b', 'c', 'd', 'e')` 
                : '';

            const uniqueKeyAssertion = config.qualityChecks.uniqueKey
                ? `\n\n-- ASSERTION (Test Unitaire g√©n√©r√©)\nSELECT ${config.qualityChecks.uniqueKey}\nFROM ${config.tableName}\nGROUP BY 1 HAVING COUNT(*) > 1`
                : '';

            const sql = `-- G√©n√©r√© dynamiquement par definitions/models/staging.js
-- Configuration source: ${config.tableName}.json

CREATE OR REPLACE TABLE \`project.dataset.${config.tableName}\`
OPTIONS(
  description="${config.description}"
) AS
SELECT
  JSON_VALUE(raw_json.${Object.keys(config.columns)[0]}) as ${Object.keys(config.columns)[0]},
  TRIM(JSON_VALUE(raw_json.${Object.keys(config.columns)[1]})) as ${Object.keys(config.columns)[1]}
FROM
  \`project.dataset.${config.sourceTable}\`
WHERE
  raw_json IS NOT NULL${qualityCheckSQL};${uniqueKeyAssertion}`;

            const outputEl = document.getElementById('sql-output');
            outputEl.innerText = "";
            
            // Simple typing effect
            let i = 0;
            const speed = 5;
            function typeWriter() {
                if (i < sql.length) {
                    outputEl.innerText += sql.charAt(i);
                    i++;
                    setTimeout(typeWriter, speed);
                }
            }
            typeWriter();
        }

        // 5. Chart.js Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Cost Chart
            const ctxCost = document.getElementById('costChart').getContext('2d');
            new Chart(ctxCost, {
                type: 'bar',
                data: {
                    labels: ['Scan Complet', 'Partitionn√©'],
                    datasets: [{
                        label: 'Co√ªt ($ / Requ√™te)',
                        data: [5.0, 0.2], // Example data illustrating massive savings
                        backgroundColor: ['#cbd5e1', '#34a853'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' $';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Co√ªt ($)' } }
                    }
                }
            });

            // Reliability Chart
            const ctxRel = document.getElementById('reliabilityChart').getContext('2d');
            new Chart(ctxRel, {
                type: 'line',
                data: {
                    labels: ['Semaine 1', 'Semaine 2', 'Semaine 3', 'Semaine 4'],
                    datasets: [{
                        label: 'Taux de succ√®s Pipeline',
                        data: [75, 82, 95, 99.5],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { min: 60, max: 100, title: { display: true, text: 'Succ√®s (%)' } }
                    }
                }
            });
        });
    </script>
</body>
</html>